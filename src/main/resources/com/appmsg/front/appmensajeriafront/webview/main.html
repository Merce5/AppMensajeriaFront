<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AppMensajería</title>

    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/main.css" />
</head>

<body>
<header class="topbar">
    <div class="container topbar-inner">
        <div class="app-title">AppMensajería</div>

        <div class="topbar-spacer"></div>

        <div class="topbar-actions">
            <button class="icon-btn" type="button" title="Nuevo chat">＋</button>
            <button class="avatar-btn" type="button" title="Ajustes" onclick="Bridge.navigate('settings.html')">
        <span class="avatar-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </span>
            </button>
        </div>
    </div>
</header>

<main class="container content">
    <div class="row-between header-block">
        <div>
            <div class="kicker">Chats</div>
            <h1 class="page-title">Conversaciones</h1>
        </div>

        <div class="status-pill">
            <span class="presence-dot" aria-hidden="true"></span>
            Conectado
        </div>
    </div>

    <div class="grid-2">
        <section class="card">
            <h3 class="card-title">Recientes</h3>
            <div id="chats-list">
                <div class="loading-state">
                    <p style="color:var(--muted);text-align:center;padding:var(--spacing-lg)">Cargando chats...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Estado sin chats -->
    <div id="empty-state" class="card hidden" style="text-align:center;padding:var(--spacing-xl)">
        <p style="color:var(--muted);margin-bottom:var(--spacing-md)">No tienes conversaciones</p>
        <button class="icon-btn" type="button" onclick="Bridge.navigate('invite.html')" style="padding:8px 16px">
            Unirse con enlace
        </button>
    </div>
</main>
<script src="js/bridge.js"></script>
<script>
    (function () {
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(w => w.charAt(0)).join('').substring(0, 2).toUpperCase();
        }

        function escapeHtml(text) {
            var d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        function openChat(chatId) {
            Bridge.setChatId(chatId);
            Bridge.navigate('chat.html');
        }

        // Hacer openChat global para que funcione desde onclick
        window.openChat = openChat;

        function renderChats(chats) {
            var container = document.getElementById('chats-list');
            var emptyState = document.getElementById('empty-state');

            if (!chats || chats.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = chats.map(function (chat) {
                var name = chat.chatName || chat.name || 'Chat';
                var image = chat.chatImage || chat.image || '';
                var initials = getInitials(name);
                var avatar = image
                    ? '<img src="' + image + '" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover">'
                    : initials;
                var preview = chat.lastMessage ? escapeHtml(chat.lastMessage) : '';
                var time = chat.lastMessageTime || '';

                return '<button class="chat-row" type="button" onclick="openChat(\'' + chat.id + '\')">'
                    + '<div class="chat-avatar">' + avatar + '</div>'
                    + '<div class="grow">'
                    + '  <div class="chat-name">' + escapeHtml(name) + '</div>'
                    + '  <div class="chat-preview">' + preview + '</div>'
                    + '</div>'
                    + '<div class="chat-time">' + escapeHtml(time) + '</div>'
                    + '</button>';
            }).join('');
        }

        // Callback que invoca Java con la lista de chats
        window.onChatsReceived = function (result) {
            var chats = (typeof result === 'string') ? JSON.parse(result) : result;
            renderChats(chats);
        };

        // Pedir chats al bridge cuando esté listo
        Bridge.whenReady(function () {
            Bridge.log('Main: requesting chats');
            Bridge.getChats();
        });
    })();
</script>
</body>
</html>

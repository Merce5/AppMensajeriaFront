<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AppMensajerÃ­a</title>

    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/base.css"/>
    <script src="js/bridge.js"></script>
    <script src="js/utils.js"></script>
</head>

<body>
<header class="topbar">
    <div class="container topbar-inner">
        <div class="app-title">AppMensajerÃ­a</div>

        <div class="topbar-spacer"></div>

        <div class="topbar-actions">
            <button class="icon-btn" type="button" title="Unirse con enlace" onclick="Bridge.navigate('invite.html')">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
            </button>
            <button class="icon-btn" type="button" title="Nuevo chat" onclick="toggleNewChat()">ï¼‹</button>
            <button class="avatar-btn" type="button" title="Ajustes" onclick="Bridge.navigate('settings.html')">
        <span class="avatar-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </span>
            </button>
        </div>
    </div>
</header>

<main class="container content">
    <div class="row-between header-block">
        <div>
            <div class="kicker">Chats</div>
            <h1 class="page-title">Conversaciones</h1>
        </div>

        <div class="status-pill">
            <span class="presence-dot" aria-hidden="true"></span>
            Conectado
        </div>
    </div>

    <div class="grid-2">
        <section class="card">
            <h3 class="card-title">Recientes</h3>
            <div class="chats-container">
                <div id="chats-list">
                </div>
            </div>
        </section>

        <!-- Menu creacion de chat -->
        <section id="new-chat-card" class="card hidden">
            <h3 class="card-title">Crear un nuevo chat</h3>
            <div style="padding: var(--spacing-md) 0;">
                <form id="new-chat-form">
                    <!-- Nombre del chat -->
                    <div class="form-group" style="margin-bottom: var(--spacing-md);">
                        <label for="chat-name"
                               style="display: block; margin-bottom: var(--spacing-xs); color: var(--text) !important;">
                            Nombre del chat
                        </label>
                        <input
                                type="text"
                                id="chat-name"
                                placeholder="Escribe un nombre para el chat"
                                style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--border); border-radius: var(--radius-sm);"
                        />
                    </div>

                    <!-- Contador de participantes -->
                    <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                        <label style="display: block; margin-bottom: var(--spacing-xs); color: var(--text);">
                            NÃºmero de participantes
                        </label>
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <button
                                    type="button"
                                    class="icon-btn"
                                    onclick="changeParticipantCount(-1)"
                                    style="border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"
                            >
                                âˆ’
                            </button>
                            <span
                                    id="participant-count"
                                    style="font-size: 1.5rem; min-width: 40px; text-align: center;"
                            >
                        1
                    </span>
                            <button
                                    type="button"
                                    class="icon-btn"
                                    onclick="changeParticipantCount(1)"
                                    style="border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"
                            >
                                ï¼‹
                            </button>
                        </div>
                    </div>

                    <!-- Campo de salida para enlace/cÃ³digo -->
                    <div class="form-group" style="margin-bottom: var(--spacing-md);">
                        <label style="display: block; margin-bottom: var(--spacing-xs); color: var(--text);">
                            Enlace de invitaciÃ³n
                        </label>
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <input
                                    type="text"
                                    id="invitation-link"
                                    readonly
                                    placeholder="Se generarÃ¡ al crear el chat"
                                    style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--border); border-radius: var(--radius-sm); background-color: var(--surface-3); cursor: not-allowed;"
                            />
                            <button
                                    type="button"
                                    class="icon-btn"
                                    onclick="copyInvitationLink()"
                                    style="border-radius: var(--radius-sm); padding: var(--spacing-sm);"
                                    title="Copiar enlace"
                            >
                                ðŸ“‹
                            </button>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div id="create-buttons" style="display: flex; gap: var(--spacing-md);">
                        <button type="button" class="btn btn-primary" onclick="createNewChat()">
                            Crear chat
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="hideNewChat()">
                            Cancelar
                        </button>
                    </div>
                    <!-- Botones post-creacion (ocultos inicialmente) -->
                    <div id="post-create-buttons" class="hidden" style="gap: var(--spacing-md); flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" onclick="goToCreatedChat()">
                            Ir al chat
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearNewChat()">
                            Crear otro
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </div>
</main>
<script>

    function toggleNewChat() {
        const newChatCard = document.getElementById('new-chat-card');
        if (newChatCard.classList.contains('hidden')) {
            newChatCard.classList.remove('hidden');
        } else {
            newChatCard.classList.add('hidden');
        }
    }

    // Variable para guardar el chatId creado
    let lastCreatedChatId = null;

    function hideNewChat() {
        const newChatCard = document.getElementById('new-chat-card');
        newChatCard.classList.add('hidden');
        // Limpiar formulario
        document.getElementById('chat-name').value = '';
        document.getElementById('participant-count').textContent = '1';
        document.getElementById('invitation-link').value = '';
        // Resetear botones
        document.getElementById('create-buttons').classList.remove('hidden');
        document.getElementById('post-create-buttons').classList.add('hidden');
        lastCreatedChatId = null;
    }

    function goToCreatedChat() {
        if (lastCreatedChatId) {
            Bridge.setChatId(lastCreatedChatId);
            Bridge.navigate('chat.html');
        }
    }

    function clearNewChat() {
        const newChatCard = document.getElementById('new-chat-card');
        // Limpiar formulario
        document.getElementById('chat-name').value = '';
        document.getElementById('participant-count').textContent = '1';
        document.getElementById('invitation-link').value = '';
        // Resetear botones
        document.getElementById('create-buttons').classList.remove('hidden');
        document.getElementById('post-create-buttons').classList.add('hidden');
        lastCreatedChatId = null;
    }


    // Hacer las funciones globales
    window.toggleNewChat = toggleNewChat;
    window.hideNewChat = hideNewChat;
    window.goToCreatedChat = goToCreatedChat;
    window.clearNewChat = clearNewChat;

    // Funciones para el contador de participantes
    function changeParticipantCount(delta) {
        const countElement = document.getElementById('participant-count');
        let currentCount = parseInt(countElement.textContent);
        let newCount = currentCount + delta;

        // No permitir valores menores a 1
        if (newCount < 1) return;

        countElement.textContent = newCount;
    }

    function createNewChat() {
        const chatName = document.getElementById('chat-name').value.trim();
        const participantCount = parseInt(document.getElementById('participant-count').textContent);
        const createBtn = document.querySelector('#new-chat-form .btn-primary');
        const invitationInput = document.getElementById('invitation-link');

        // Validaciones bÃ¡sicas
        if (!chatName) {
            alert('Por favor, introduce un nombre para el chat');
            return;
        }

        // Deshabilitar botÃ³n mientras se procesa
        createBtn.disabled = true;
        createBtn.textContent = 'Creando...';

        Bridge.log(`Creando chat: ${chatName} con ${participantCount} participantes`);

        Bridge.createNewChat(chatName, participantCount)
            .then(response => {
                Bridge.log('Chat creado: ' + JSON.stringify(response));

                // Guardar el chatId creado
                lastCreatedChatId = response.chatId;

                // Mostrar el enlace de invitaciÃ³n
                if (response.inviteCode) {
                    invitationInput.value = response.inviteCode;
                }

                // Actualizar la lista de chats
                Bridge.getChats();

                // Cambiar a los botones post-creaciÃ³n
                document.getElementById('create-buttons').classList.add('hidden');
                document.getElementById('post-create-buttons').classList.remove('hidden');
                document.getElementById('post-create-buttons').style.display = 'flex';
            })
            .catch(error => {
                Bridge.log('Error creando chat: ' + error.message);
                alert('Error al crear el chat: ' + error.message);
            })
            .finally(() => {
                createBtn.disabled = false;
                createBtn.textContent = 'Crear chat';
            });
    }

    function copyInvitationLink() {
        const input = document.getElementById('invitation-link');
        const link = input.value;

        if (!link) {
            alert('Crea un chat primero.');
            return;
        }

        // Seleccionar y copiar
        input.select();
        input.setSelectionRange(0, 99999);

        // Usar API moderna si estÃ¡ disponible, sino fallback
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(link);
        } else {
            document.execCommand('copy');
        }

        // Feedback visual
        const btn = document.querySelector('button[onclick="copyInvitationLink()"]');
        const original = btn.textContent;
        btn.textContent = 'âœ…';
        setTimeout(() => btn.textContent = original, 1000);
    }

    // Hacer las funciones globales
    window.changeParticipantCount = changeParticipantCount;
    window.createNewChat = createNewChat;
    window.copyInvitationLink = copyInvitationLink;

    (function () {
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(w => w.charAt(0)).join('').substring(0, 2).toUpperCase();
        }

        function escapeHtml(text) {
            let d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        function openChat(chatId) {
            Bridge.setChatId(chatId);
            Bridge.navigate('chat.html');
        }

        // Hacer openChat global para que funcione desde onclick
        window.openChat = openChat;

        function renderChats(chats) {
            let container = document.getElementById('chats-list');

            if (!Array.isArray(chats) || chats.length === 0) {
                container.innerHTML = `
            <div class="loading-state">
                <p style="color:var(--muted);text-align:center;padding:var(--spacing-lg)">
                    No tiene ningÃºn chat
                </p>
            </div>
        `;
                return;
            }

            container.innerHTML = chats.map(function (chat) {
                let name = chat.chatName || chat.name || 'Chat';
                let image = chat.chatImage || chat.image || '';
                let initials = getInitials(name);
                let avatar = image
                    ? '<img src="' + image + '" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover">'
                    : initials;
                let preview = chat.lastMessage ? escapeHtml(chat.lastMessage) : '';
                let time = chat.lastMessageTime || '';

                return '<button class="chat-row" type="button" onclick="openChat(\'' + chat.id + '\')">'
                    + '<div class="chat-avatar">' + avatar + '</div>'
                    + '<div class="grow">'
                    + '  <div class="chat-name" style="color: var(--text)">' + escapeHtml(name) + '</div>'
                    + '  <div class="chat-preview">' + preview + '</div>'
                    + '</div>'
                    + '<div class="chat-time">' + escapeHtml(time) + '</div>'
                    + '</button>';
            }).join('');
        }

        // Callback que invoca Java con la lista de chats
        window.onChatsReceived = function (result) {
            let chats = (typeof result === 'string') ? JSON.parse(result) : result;
            renderChats(chats);
        };

        // Pedir chats al bridge cuando estÃ© listo
        Bridge.whenReady(function () {
            Bridge.log('Main: requesting chats');
            Bridge.getChats();
        });
    })();

    Bridge.whenReady(() => {
        if (window.javaBridge && typeof javaBridge.loadSettings === "function") {
            javaBridge.loadSettings();
        }
    });

    function onSettingsLoaded(dto) {
        if (dto && typeof dto.darkMode !== "undefined") {
            Utils.applyTheme(!!dto.darkMode);
        }
    }
</script>

</body>
</html>

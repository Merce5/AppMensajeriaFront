<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chat - AppMensajer√≠a</title>

    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/chat.css" />
</head>

<body>
    <div class="chat-container" id="chat-main-container">
        <!-- Header del chat -->
        <header class="chat-header">
            <button class="btn-icon" onclick="Bridge.goBack()" title="Volver">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>

            <div class="chat-info" onclick="Chat.openProfile()">
                <img id="chat-avatar" class="avatar" src="" alt="" onerror="this.style.display='none'">
                <div class="chat-info-text">
                    <span id="chat-name" class="chat-name">Chat</span>
                    <span id="chat-status" class="chat-status">Conectando...</span>
                </div>
            </div>
        </header>

        <!-- Lista de mensajes -->
        <main class="messages-container" id="messages">
            <div class="empty-chat" id="empty-state">
                <svg class="empty-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                </svg>
                <p>No hay mensajes aun</p>
            </div>
        </main>

        <!-- Indicador de typing -->
        <div id="typing-indicator" class="typing-indicator hidden">
            <span id="typing-user"></span> esta escribiendo
            <span class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </span>
        </div>

        <!-- Barra de input -->
        <footer class="input-bar">
            <!-- Preview de archivos adjuntos -->
            <div id="attachments-preview" class="attachments-preview hidden"></div>

            <div class="input-row">
                <button class="btn-icon" onclick="Chat.openFilePicker()" title="Adjuntar archivo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>

                <input type="text"
                       id="message-input"
                       placeholder="Escribe un mensaje..."
                       autocomplete="off"
                       onkeyup="Chat.handleTyping(event)"
                       onkeypress="Chat.handleKeyPress(event)">

                <button class="btn-send" onclick="Chat.sendMessage()" title="Enviar">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <script src="js/bridge.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/chat.js"></script>
    <script>
    Bridge.whenReady(() => {
        if (window.javaBridge && typeof javaBridge.loadSettings === "function") {
            javaBridge.loadSettings();
        }
    });

    function onSettingsLoaded(dto) {
        if (dto && typeof dto.darkMode !== "undefined") {
            Utils.applyTheme(!!dto.darkMode);
        }
        const container = document.getElementById('chat-main-container');
        // Elimina cualquier clase anterior de fondo
        container.classList.remove('force-red-bg', 'wallpaper-custom');
        let styleTag = document.getElementById('wallpaper-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'wallpaper-style';
            document.head.appendChild(styleTag);
        }
        if (dto && dto.wallpaperPath) {
            container.classList.add('wallpaper-custom');
            styleTag.textContent = `.chat-container.wallpaper-custom { background: url('${dto.wallpaperPath}') center center / cover no-repeat fixed !important; }`;
        } else {
            styleTag.textContent = '';
        }
    }
    </script>
</body>
</html>
